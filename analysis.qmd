---
title: "Diabetes Risk Prediction"
format: html
editor: visual
---

```{r}

# Load required packages
library(tidyverse)
library(broom)
library(readr)

# Create in-memory SQLite DB and copy CSV into a table
library(DBI)
library(RSQLite)
```

## Load Data

```{r}

# Create a temporary, in-memory SQLite database (no files saved to disk)
con <- dbConnect(RSQLite::SQLite(), ":memory:")

# Load the synthetic EHR dataset from CSV into R as a data frame
ehr <- read_csv("data/mock_ehr.csv")

# Copy the R data frame into the SQLite database as a table called "patients"
dbWriteTable(con, "patients", ehr, overwrite = TRUE)
```

## Load Data

```{r}

# Convert to factors where needed
ehr <- ehr %>%
  mutate(
    sex = factor(sex),
    smoker = factor(smoker),
    has_diabetes = factor(has_diabetes, levels = c(0, 1), labels = c("No", "Yes"))
  )

# Check missing values
ehr %>% summarise(across(everything(), ~sum(is.na(.))))
```

## Exploratory Analysis

```{r}
# BMI distribution by diabetes status
ehr %>%
  ggplot(aes(x = bmi, fill = has_diabetes)) +
  geom_density(alpha = 0.4)
  labs(title = "BMI Distribution by Diabetes Status", x = "BMI", fill = "Diabetes")
```

## Logistic Regression

```{r}
# Build model to predict diabetes
model <- glm(has_diabetes ~ age + sex + smoker + bmi + systolic_bp + cholesterol,
             data = ehr, family = binomial)

# Summarize results
summary(model)

# Tidy output
tidy(model, exponentiate = TRUE, conf.int = TRUE)


```

## Interpretation

```{r}

# Plot odds ratios
tidy(model, exponentiate = TRUE, conf.int = TRUE) %>%
  ggplot(aes(x = reorder(term, estimate), y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  coord_flip() +
  labs(title = "Odds Ratios for Diabetes Risk", x = "", y = "Odds Ratio")

```
